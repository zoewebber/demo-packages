- pipeline: build-and-test
  name: build and test
  refs:
  - :default
  events:
  - type: WEBHOOK
  fail_on_prepare_env_warning: true
  variables:
  - key: BUDDY_API_URL
    value: https://api.buddy.works
    type: VAR
  - key: NODE_TLS_REJECT_UNAUTHORIZED
    value: 0
    type: VAR
  actions:
  - action: npm install
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm install --ignore-scripts
    - ""
    setup_commands:
    - npx playwright install --with-deps
    shell: BASH
  - action: npm run test:unit:ci
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm run test:unit:ci
    shell: BASH
    variables:
    - key: BUDDY_UT_TOKEN
      value: bud_ut_us_x02fiqoqzpou2ihdfq9cilyubv6aom
      type: VAR
  - action: npm run test:e2e:ci
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm run test:e2e:ci
    - ""
    setup_commands:
    - npx playwright install --with-deps
    - "#npx playwright install-deps "
    shell: BASH
    variables:
    - key: BUDDY_UT_TOKEN
      value: bud_ut_us_a9n5b02k3xx0oxeyd4co7k87guhzro
      type: VAR
  - action: test storybook
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm run build-storybook
    - cd storybook-static && bdy visual storybook
    setup_commands:
    - npm i -g bdy@1.12.5-dev
    shell: BASH
    variables:
    - key: BUDDY_VT_TOKEN
      value: bud_vt_us_oa06n0or26zj6nfhz976r44uzwdpra
      type: VAR
    vt_suite: storybook
