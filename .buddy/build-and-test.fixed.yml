- pipeline: build-and-test
  name: build and test
  refs:
  - '*'
  events:
  - type: WEBHOOK
  - type: PUSH
  fail_on_prepare_env_warning: true
  concurrent_pipeline_runs: true
  actions:
  - action: npm install
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm install --ignore-scripts
    - ""
    setup_commands:
    - npx playwright install --with-deps
    shell: BASH
  - action: npm run build
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm run build
    - ""
    setup_commands:
    - npx playwright install --with-deps
    shell: BASH
    run_next: IN_SOFT_PARALLEL
  - action: npm run test:unit:ci
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - printenv
    - npm run test:unit:ci
    - ""
    shell: BASH
    unit_tests_suite: unit
  - action: npm run test:e2e:ci
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - nohup npm run dev &
    - npm run test:e2e:ci
    - ""
    setup_commands:
    - npx playwright install --with-deps
    - npm i -g bdy@1.14.2-dev
    shell: BASH
    run_next: IN_SOFT_PARALLEL
    vt_suite: application
    unit_tests_suite: e2e
  - action: test storybook
    type: BUILD
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - npm run build-storybook
    - cd storybook-static && bdy visual storybook
    setup_commands:
    - npm i -g bdy@1.14.0
    shell: BASH
    vt_suite: storybook
  - action: Publish storybook package
    type: PUBLISH_PACKAGE_VERSION
    input_type: BUILD_ARTIFACTS
    local_path: /storybook-static
    run_next: IN_SOFT_PARALLEL
    package: storybook
    versions:
    - $BUDDY_RUN_REF_NAME
  - action: Publish app package
    type: PUBLISH_PACKAGE_VERSION
    input_type: BUILD_ARTIFACTS
    local_path: /dist
    package: app
    versions:
    - $BUDDY_RUN_REF_NAME
